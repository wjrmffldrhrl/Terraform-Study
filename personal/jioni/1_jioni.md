# 11/27

**[테라폼 스터디]**  Terraform up&leanning - ch1. **why terraform**

옛날 시스템 관리자들은 (sysadmins) 인프라를 수동으로 관리하고있었다.  모든 서버,데이터베이스,로드밸런서,네트워크를 수작업으로 생성하고 관리했다.  때문에 서버다운,잘못 구성, 배포 느리고,잦은 오류, 관리자의 부재등을 걱정했다. 데브옵스 즉 테라폼의 등장으로 더 나은 작업방법을 만들수 있다.

테라폼은 해시코프(HashiCorp)에서 만든 오픈소스 도구로, 선언적 언어를 사용하여 인프라를 코드로 정의한다. (Infrastructure as Code= IaC) (코드형 인프라)  

그리고 *(퍼블릭/프라이빗)클라우드와 가상화 플랫폼에서 인프라를 배포 및 관리하게 된다. 

테라폼을 사용하는 코드형 인프라관리 , 전체 데브옵스 학습

## [데브옵스의 등장]

하드웨어를 관리하는 팀은 운영팀(Ops)
소프트웨어를 개발하는 팀은 개발팀(Devs)라고 불렀다. 일반적으로는 개발팀이 애플리케이션을 만들어 운영팀으로 넘겨주고 , 운영팀은 애플리케이션을 어떻게 배포하고 운영할지 결정한다. 이 작업을 수동으로 했었다.
그러나 오늘날 클라우드 서비스가 등장하면서 운영팀은 하드웨어에 많은 돈과 시간을 투자하는대신 애플리케이션 작업에 더많은 시간을 투자하기위해 테라폼,도커같은 도구를 사용하기 시작했다.
결과적으로 개발팀과 운영팀 모두 소프트웨어 작업에  대부분의 시간을 소비하여 팀간의 구분이 모호 해져 DevOps가 탄생했다. 데브옵스는 팀 이나 특정 기술이 아닌 일련의 프로세스 즉, 데브옵스란 소프트웨어를 효율적으로 전달하는 프로세스다.
이제 데브옵스로 ci/cd 코드를 지속적 통합, 항상 배포가능한 상태유지. 탄력적이고 자가치유 가능한 시스템을 만들고 모니터링 및 알람설정을 통해 자동으로 해결할수없는 문제를 해결한다.
데브옵스의 4가지 핵심가지 CAMS culture Automation Measurement sharing 문화 자동화 측정 공유다.
데브옵스의 목표는 sw배포를(software delivery) 최대한 자동화 하는 것이다.
따라서 수동으로 실행하는 대신 코드를 통해 인프라를 관리 할수있다. 이것을 코드형 인프라 라고한다.

## [코드형 인프라]

코드형 인프라란 (Infrastructure as Code, IaC) : 코드를 작성,실행하여 인프라를 생성,배포,수정,정리하는 것을 말한다. 코드형 인프라 도구에는 다섯가지 범주가 있다.

1. ad hoc script
2. 구성 관리도구
3. 서버 템플릿
4. 오케스트레이션 도구
5. 프로비젼 도구

## [애드훅 스크립트]

자동화하는 가장 간단한 방법은 ad hoc  script 를 사용하는 것이다.
1. 수행할 작업을 단계별로 나눈다
2. 선호하는 언어사용해 각 단계를 코드로 정의(bash,Ruby,python)
3. 작성된 스크립트를 서버에서 수동으로 실행

이 예시는 사용자가 매번 수동으로 작업해야한다. 그러나 코드형 인프라를 위해 특수 제작된 도구를 사용하면 이런 복잡한 작업을 간결한 API로 수행할 수 있다.
애드훅 스크립트는 소규모 일회성 작업에는 적합하지만, 모든 인프라를 코드로 관리하려면 작업 목적에 맞게 설계된 코드형 인프라 도구를 사용해야한다.

[구성 관리 도구] ****configuration management tools****
*셰프 Chef, 퍼핏 Puppet, 앤서블 Ansible, 솔트 Salt 등은 모두 구성 관리도구로써 대상 서버에 sw를 설치하고 관리하도록 설계되어있다. 

구성 관리 도구를 사용하면 애드훅 스크립트를 사용할때와 다른 장점이 있다.

---

- ****configuration management tools****
    
    *[https://opensource.com/article/18/12/configuration-management-tools?extIdCarryOver=true&sc_cid=701f2000001OH7EAAW](https://opensource.com/article/18/12/configuration-management-tools?extIdCarryOver=true&sc_cid=701f2000001OH7EAAW)
    *Ansible은 애플리케이션과 시스템을 보다 쉽게 배포할 수 있게 해주는  IT 자동화 플랫폼
    *Chef 구성 관리의 이점을 전체 인프라에 제공하도록 구축된 시스템 통합 프레임워크. 인프라를 최신 상태로 유지하고 규정을 준수
    *Linux, Unix 및 Windows 시스템을 위한 자동화된 관리 엔진인 Puppet은 중앙 집중식 사양을 기반으로 관리 작업(예: 사용자 추가, 패키지 설치 및 서버 구성 업데이트)을 수행
    *Salt 규모에 맞게 모든 인프라 또는 애플리케이션의 관리 및 구성을 자동화하는 소프트웨어. 고속 데이터 수집 및 수만 대 이상의 서버 확장을 위해 만들어졌다.
    

---

- 코딩규칙 coding convention

앤서블은 문서화 , 파일 레이아웃, 매개변수(명확하게 이름붙여진) , 시크릿 관리 등을 포함해 일관되고 예측가능한 구조를 제공한다.

다양한 양식으로 애드훅 스크립트를 작성할수 있지만 구성관리도구에는 코딩 규칙이 포함되어있어 코드를 쉽게 탐색할수있게 해준다.

- 멱등성

**여러 번 적용하더라도 결과가 달라지지 않는 성질**

멱등성을 가진코드(idempotent code) : 실행횟수에 관계없이 올바르게 동작하는 코드

bash shell script를 idempotent code→ 복잡한 조건문 구조

앤서블 제공하는 기능은 기본적으로 멱등성을 가진다. 

- 분산형 구조

애드훅 스크립트 → stand alone local machine 실행 설계

구성 관리 도구 →  원격의 많은 서버를 관리하기 위해 설계

## [서버 템플릿 도구]

서버 템플릿 도구란 구성관리도구의 대안으로 
운영체제 ,sw , 파일 및 기타 필요한 모든 내용을 포함하고있는 ‘스냅샷’으로 이미지를 생성한다. 그런다음 앤서블과 같은 코드형 인프라 도구를 사용하여 모든 서버에 이미지를 설치할수있다. 
(이미지 복사!)
Docker , Packer, Vagrant등이 있다.

(기존서버 구성방식→ 서버 여러대 시작→ 각각 동일코드 실행 서버구성)

- 가상머신 VM
HW포함 전체 컴퓨터 시스템 복제하여 가상화(CPU RAM HDD NW)
VMware, VirtualBox
- 컨테이너 Container
OS의 사용자 공간 복제 .  컨테이너간 공간 격리된다.

서버 템플릿들은 각각의 목적이 약간 다르다.

Packer :  프로덕션서버에서 직접 실행하는 이미지 생성

vagrant:  개발 컴퓨터에서 실행되는 이미지 생성

Docker: 개별 응용프로그램의 이미지 생성

서버 템플릿은 불변인프라 immutable infrastructure  로 전환하는데 있어 핵심적인 구성 요소.

불변 인프라의 개념은 불변 변수 immutable variable 개념에서 등장한 것.

변수설정후에는 다시설정x → 새로운 변수 만들어야함→ 코드추론 쉬워짐

이처럼 서버는 변경x → 새 이미지 배포 → 배포된 부분 관리 쉬워짐

## [오케스트레이션 도구]

생선된 VM 과 container 를 관리하기 위해 다음의 관리 수행이 필요하다

<aside>
💡 VM 과 컨테이너 HW에 효율적 배포

</aside>

<aside>
💡 [배포 전략: Rolling, Blue/Green, Canary](https://onlywis.tistory.com/10) 사용하여 기존 VM,container 롤백

</aside>

<aside>
💡 VM, container 상태 모니터링, 비정상적인 부분 자동복구

</aside>

<aside>
💡 트래픽에 따라 VM,container 자동확장(자동감소)

</aside>

<aside>
💡 VM, container 트래픽 분산 (로드 밸런싱)

</aside>

<aside>
💡 서로 다른 네트워크에 있더라도 VM, container 서로 식별,통신 (서비스 검색)

</aside>

이 작업처리를 위해 kubernetes , marathon mesos , amazon ECS, Docker swarm, Nomard 와 같은 오케스트레이션 도구를 사용한다.

컨테이너를 관리하고 작동하기 위해서 서버그룹을 배포한다. 클라우드서비스는 시스템 자체에서 쿠버네티스 클러스터를 지원하는 경우도 있다.

동작하는 클러스터가 있다면 컨테이너를 YamL파일에 코드로 정의 할수 있다.

## [프로비전 도구]

구성관리, 서버템플릿 및 오케스트레이션 도구가 각 서버에 실행되는 코드를 정의 한다면,
프로비젼 도구는 서버 자체를 생성한다. 서버만 생성하는것이 아니라 DB,cache, Load Balancer, queue, monitering, subnet, firewall , Routing ,SSL 인증서 등 인프라에 관한 거의 모든 부분을 프로비저닝 할수 있다.

---

- 프로비저닝(provisioning)
    
    **사용자의 요구에 맞게 시스템 자원을 할당, 배치, 배포해 두었다가 필요 시 시스템을 즉시 사용할 수 있는 상태로 미리 준비해 두는 것을 말한다**
    

---

## [코드형 인프라의 장점]

WHY 새로운 언어와 도구를 배우고 더많은 코드를 관리해야하는 걸까?

A. 코드로 많은 것을 할 수있기 때문. 수동으로 코드를 변환하지 않아도 되므로 SW를 효율적으로 배포할수 있다. 인프라가 코드로 정의 되면 다음과 같은 배포 프로세스를 극적으로 개선한다.

- 자급식 배포
    
    소수의 관리자만 프로덕션 환경에 접속해 배포진행
    
- 속도와 안정성
    
    수동보다 오류적으므로 더 안전함
    
- 문서화
    
    코드형 인프라는 문서역할을 하여 조직의 모든 사람이 인프라 구조 이해하고 업무 진행
    
- 버전관리
    
    인프라 변경 내역 남아있으므로 문제가 없던 이전 코드로 돌리는등 디버깅을 돕는 도구가 된다
    
- 유효성 검증
    
    코드가 변경될때마다 검증을 수행하고 자동화된 테스트를 진행할수있고, 정적분석 프로그램에 코드를 전달하여 오류발생 위험 감소
    
- 재사용성
    
    재사용 가능한 모듈로 패키징할수있으므로 검증된 모듈로 일관된 배포 가능
    
- 행복
    
    반복적이고 지루한 수동적 인프라 관리에 벗어나 개발자가 코드개발 작업에 더 집중할 수 있도록 대안 제시
    

## [테라폼의 작동방식]

**테라폼**은 해시코프 사가 Go언어로 개발한 오픈소스 도구.

OS마다 바이너리 파일이 존재하는데 GO코드는 하나의 바이너리 파일로 컴파일됨

terraform 명령어로 실행

바이너리를 사용하여 어떤 컴퓨터에서든 인프라를 배포할수 있다.

테라폼은 클라우드 서비스에서 제공하는 API서버를 활용하고 AWS에서 이미 보유한 API 키 와 같은 인증 매커니즘도 사용하고있다.

HOW 테라폼이 API호출?
A. 테라폼은 생성하려는 인츠라 정보가 담겨있는 텍스트로 이루어진 테라폼 구성 파일을 생성해 API를 호출한다. 이것이 코드형 인프라를 만드는 코드

테라폼 구성 파일에 서버,DB,로드 밸런서,네트워크 토폴로지등 전체 인프라를 정의하고 해당 파일의 버전을 관리할 수 있다. 그런다음 명령어를 사용해 인프라를 배포할수 있다. **테라폼 바이너리**는 사용자가 구성한 코드 파싱 → 지정 클라우드 API호출로 변환→효율적인 API호출

테라폼을 사용하여 구성 수정할수 있다. → 자동 테스트와 코드리뷰로 유효성 검증→버전관리 시스템에 코드 커밋→ `terraform apply` 명령어로 변경 수행하는 API호출하여 인프라 변경진행

 

## [테라폼과 다른 코드형 인프라 도구 비교]

어떤 도구를 선택할지 고려할 절충사항들

- [구성관리 vs 프로비저닝]
    
    구성관리도구 : 프로비전 수행O
    프로비전도구: 구성 수행O
    둘다 비슷하게 수행하므로 목적에 맞는 도구를 선택한다.
    프로비전→프로비전 도구 선택이 최선
    서버템플릿 도구를 사용 X : 구성관리 도구 및 프로비전 도구 함께사용
    
- [가변인프라 vs 불변 인프라]
    
    구성관리도구 : 가변 인프라 → 실제운영환경 서버에서 테스트 환경에 반영되지않은 지난 변경사항이 누적됨→ 운영서버에서는 다르게 동작할수 있음
    
    프로비전도구: 새로운 서버 배포와 같다. 이미지 작성후 배포→ 이전 서버 종료→테스트 환경에서 통과한 이미지는 운영 환경에서도 동일하게 배포→ 동일하게 동작
    하지만 이미지 재구성하고 모든 서버를 재배치 하므로 시간이 오래걸림
    
- [절차적 언어vs선언적 언어]
    
    chef , ansible : 절차적 스타일 코드 권장
    테라폼,클라우드 포메이션, 솔트, 퍼펫등 : 선언적 방식
    선언적 언어: 구현하려는 최종 상태 지정하는 코드,간소하고 이해하기쉽다,재사용쉽다
    절차적 언어: 인프라의 상태정보 기록X, 재사용 가능성 제한
    
- [마스터 서버 유무]
    
    마스터 서버의 장점
    1. 인프라의 상태를 살피고 관리할수 있는 중앙 저장소 역할, 쉽게 상황 파악
    2. 백그라운드에서 지속적으로 실행되어 , 구성의 일관성 유지. 변경사항 되돌릴수있어 문제 방지
    
- [에이전트 유무]
- [커뮤니티 규모와 활성화]
- [성숙한 기술과 최첨단 기술]
- [여러도구를 함께 사용]

## [결론]

코드형 인프라 도구는 다른 구성에서도 사용할수 있을 만큼 유연하다. 
테라폼은 완벽하지는 않지만 ( 필자의 회사기준 )모든 기준을 충족시키는 도구에 가장 가깝다는 결론이 나온다.

2장에서는 테라폼 사용법을 알아본다.