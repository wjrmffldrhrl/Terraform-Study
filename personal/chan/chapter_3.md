# 테라폼 상태 관리하기
## 1. 테라폼 상태란?
- terraform apply 를 실행하면 terraform 상태를 나타내는 tfstate 파일이 생성된다.
- 이 파일은 terraform이 실행됐을 때의 상태를 나타내는 값으로 해당 파일의 id 값등으로 aws 의 인스턴스와 구성의 차이를 알 수 있다.
- 현재 상태에 대한 내용이므로 임의로 수정하지 말아야 한다.
- 혼자 사용한다면 로컬에 저장하면 되지만, 협업을 한다면 문제가 생길 수 있다. (해결은 아래 내용)
## 2. 상태 파일 공유
- 가장 좋은 방법은 테라폼에 내장된 원격 백엔드를 사용하는 것이다.
- 원격 백엔드의 장점
  - 자동 실행: terraform apply 를 실행할 때마다 상태 파일을 가져오고, 실행 후에는 자동으로 상태 파일을 자동으로 저장한다. 
  - 잠금: 대부분의 원격 백엔드는 자동으로 잠금을 지원해서 사용 중에 다른 사람이 사용하는 걸 막아준다. -lock-timeout 이라는 명령어로 시간 조절 가능
    - DynamoDB: s3에는 잠금 기능은 없어 DynamoDB를 추가로 사용해야 한다.
  - 시크릿: 대부분의 원격 백엔드는 암호화를 지원한다.
    - s3: 원격 백엔드로 s3를 사용하면 암호화를 지원한다. 버전 관리도 지원돼서 이전 버전으로 롤백 가능  (상태 파일을 가지고 롤백을 하나?)
  - (개인평): 자동 실행 빼곤 어떤 원격 백엔드를 사용하냐에 달려 있음
- 단순하게 생각하면 버전 관리 시스템을 사용하면 된다고 생각할 수 있지만 수동으로 관리해야하는 문제와 잠금, 평문 저장의 문제로 사용하면 안 된다.
## 3. 테라폼 백엔드의 단점
1. 테라폼 코드 한 번으로 실행되지 않음 (s3 생성 코드 -> 원격 백엔드 생성 코드 -> 로컬 파일 복사 -> 백엔드 제거 -> terraform destroy)
2. 테라폼 백엔드 구성에서 변수나 참조 사용 불가
  - 부분 구성(partial configuration)을 사용하여 변수를 따로 분리하여 파일로 저장하고 인자로 전달함
  - 또는 terragrunt 사용
## 4. 상태 파일 격리
- 하나의 테라폼 코드로 모든 인프라를 관리하면 문제가 생길 수 있음
### 1. 작업 공간(workspace)을 통한 격리
  - terrafom workspace 관련 명령어로 workspace를 만들어서 격리할 수 있음
  - 단점
    - 같은 인증 메커니즘을 사용해서 프로덕션에서 다른 환경으로 분리하는 데는 적합하지 않음
    - workspace 명령어를 사용해야 하므로 정보가 부족해서 실수할 수가 
### 2. 파일 레이아웃을 통한 격리
   - 파일 구조를 애초에 분리해서 각각 저장함
   - 코드 중복이 발생하지만 테라폼 모듈을 통해서 중복하지 않고 유지할 수 있다함
   - 단점
     - 모든 구성 요소를 한 번에 실행 시키기는 힘듦 (terragrunt 사용)
     - 리소스 종속성을 사용하기 어려움 -> terraform_remote_state 사용
## 5. terraform_remote_state 데이터 소스
- 다른 테라폼 구성 세트를 읽기 전용 방식으로 저장된 테라폼 상태 파일을 가져오도록 하는 방식
- 방법
  1. output 으로 출력한 변수 추가
  2. 해당 결과가 tfstate 파일에 저장됨
  3. terraform_remote_state 테이터 소스를 추가해서 해당 파일을 읽도록 함
- 그외
  - data.terraform_remote_state.<NAME>.outputs.<ATTRIBUTE> 로 데이터 소스에서 읽을 수 있음
  - format, file 같은 내장 함수와 bash 스크립트 등을 외부로 분리하여 좀 더 깔끔하게 관리하도록 함
  - 비밀번호 등을 시크릿 매니저와 같은 툴로 관리하여 가져오도록 테라폼 코드에 저장해야 함
    - 이렇게 해도 인자로 받은 실행 상태값은 평문으로 저장됨
    - (개인평) 이게 진짜 단점 같은 데 이건 참고에 써있네?
  - 이 부분 초반에 "웹 서버는 데이터베이스보다 배포가 잦기 때문에 데이터베이스에 손상이 될 수 있으니 웹 서버 클러스터와 데이터 베이스 설정을 다른 위치에 저장하라"고 되어 있는데,
  성격이 다르기 때문에 분리하는 걸 권장하는 건 이해가 되는데 **배포가 잦기 때문에 손상을 줄 수 있다**는 건 이해하기 어려움. 멱등성 제공해주는 데?
## 6. 결론
- 하나의 코드로 여러 사람이 분리된 환경을 다 관리하는 것은 위험함으로 격리할 필요가 있음
- 그래서 테라폼에서는 여러가지 기능을 제공하고 있음
- 코드 중복의 문제가 남았는데 이건 4장에서 알려줌
